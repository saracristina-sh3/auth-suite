# Modelagem de Dados - Sistema de Controle de Acesso Granular

## üìã Vis√£o Geral

Sistema de controle de acesso baseado em **Autarquias** e **M√≥dulos** para ambiente Laravel/PostgreSQL com Docker.

### Principais Caracter√≠sticas:
- ‚úÖ Isolamento de dados por autarquia
- ‚úÖ **Relacionamento N:N entre usu√°rios e autarquias** (um usu√°rio pode pertencer a m√∫ltiplas autarquias)
- ‚úÖ Controle granular de permiss√µes por usu√°rio/m√≥dulo/autarquia
- ‚úÖ M√≥dulos compartilhados entre autarquias
- ‚úÖ Sistema de permiss√µes detalhado (leitura, escrita, exclus√£o, admin)
- ‚úÖ Contexto de autarquia ativa por usu√°rio
- ‚úÖ Integridade referencial com RESTRICT para evitar exclus√µes acidentais

## üóÑÔ∏è Estrutura do Banco de Dados

### Tabelas Criadas

#### 1. **autarquias**
Armazena as autarquias (clientes) do sistema.

| Campo | Tipo | Descri√ß√£o |
|-------|------|-----------|
| id | BIGINT (PK) | Identificador √∫nico (auto-incremento) |
| nome | VARCHAR(255) | Nome da autarquia (UNIQUE) |
| ativo | BOOLEAN | Status da autarquia |
| created_at | TIMESTAMP | Data de cria√ß√£o |
| updated_at | TIMESTAMP | Data de atualiza√ß√£o |

**√çndices:** nome, ativo

---

#### 2. **modulos**
Armazena os m√≥dulos dispon√≠veis no sistema.

| Campo | Tipo | Descri√ß√£o |
|-------|------|-----------|
| id | BIGINT (PK) | Identificador √∫nico (auto-incremento) |
| nome | VARCHAR(255) | Nome do m√≥dulo (UNIQUE) |
| descricao | TEXT | Descri√ß√£o do m√≥dulo |
| icone | VARCHAR(100) | √çcone do m√≥dulo |
| ativo | BOOLEAN | Status do m√≥dulo |
| created_at | TIMESTAMP | Data de cria√ß√£o |
| updated_at | TIMESTAMP | Data de atualiza√ß√£o |

**√çndices:** nome, ativo

---

#### 3. **users** (atualizada)
Tabela de usu√°rios com campo `autarquia_ativa_id` para contexto atual.

| Campo Relevante | Tipo | Descri√ß√£o |
|-----------------|------|-----------|
| id | BIGINT (PK) | Identificador √∫nico |
| name | VARCHAR(255) | Nome do usu√°rio |
| email | VARCHAR(255) | Email (UNIQUE) |
| password | VARCHAR(255) | Senha criptografada |
| cpf | VARCHAR(11) | CPF (UNIQUE) |
| role | VARCHAR(50) | Role global do usu√°rio |
| autarquia_ativa_id | BIGINT (FK) | **Autarquia ativa no contexto atual** |
| is_active | BOOLEAN | Status do usu√°rio |
| is_superadmin | BOOLEAN | Flag de superadmin (Suporte SH3) |
| created_at | TIMESTAMP | Data de cria√ß√£o |
| updated_at | TIMESTAMP | Data de atualiza√ß√£o |

**‚ö†Ô∏è IMPORTANTE:**
- O campo `autarquia_id` foi **REMOVIDO** (relacionamento 1:N descontinuado)
- Agora usa relacionamento N:N atrav√©s da tabela `usuario_autarquia`
- `autarquia_ativa_id` armazena qual autarquia o usu√°rio est√° usando no momento

**Chave Estrangeira:**
- `autarquia_ativa_id` ‚Üí `autarquias(id)` ON DELETE SET NULL

**√çndice:** autarquia_ativa_id

---

#### 4. **usuario_autarquia** üÜï
Tabela pivot para relacionamento N:N entre usu√°rios e autarquias.

| Campo | Tipo | Descri√ß√£o |
|-------|------|-----------|
| id | BIGINT (PK) | Identificador √∫nico |
| user_id | BIGINT (FK) | Refer√™ncia ao usu√°rio |
| autarquia_id | BIGINT (FK) | Refer√™ncia √† autarquia |
| role | VARCHAR(50) | Role espec√≠fica para esta autarquia |
| is_admin | BOOLEAN | Admin desta autarquia? |
| is_default | BOOLEAN | **Autarquia padr√£o/inicial do usu√°rio** |
| ativo | BOOLEAN | Status do v√≠nculo |
| data_vinculo | TIMESTAMP | Data de vincula√ß√£o |
| created_at | TIMESTAMP | Data de cria√ß√£o |
| updated_at | TIMESTAMP | Data de atualiza√ß√£o |

**Chave √önica:** (user_id, autarquia_id)

**Chaves Estrangeiras:**
- `user_id` ‚Üí `users(id)` ON DELETE CASCADE
- `autarquia_id` ‚Üí `autarquias(id)` ON DELETE CASCADE

**√çndices:** user_id, autarquia_id, (user_id, autarquia_id)

**Caracter√≠sticas:**
- ‚úÖ Permite que um usu√°rio perten√ßa a m√∫ltiplas autarquias
- ‚úÖ Cada v√≠nculo pode ter role e is_admin espec√≠ficos
- ‚úÖ Campo `is_default` indica a autarquia padr√£o do usu√°rio
- ‚úÖ Campo `ativo` permite desativar v√≠nculos sem exclu√≠-los

---

#### 5. **autarquia_modulo**
Tabela de relacionamento entre autarquias e m√≥dulos (m√≥dulos liberados para cada autarquia).

| Campo | Tipo | Descri√ß√£o |
|-------|------|-----------|
| autarquia_id | BIGINT (PK, FK) | Refer√™ncia √† autarquia |
| modulo_id | BIGINT (PK, FK) | Refer√™ncia ao m√≥dulo |
| data_liberacao | TIMESTAMP | Data de libera√ß√£o do m√≥dulo |
| ativo | BOOLEAN | Status da libera√ß√£o |
| created_at | TIMESTAMP | Data de cria√ß√£o |
| updated_at | TIMESTAMP | Data de atualiza√ß√£o |

**Chave Prim√°ria Composta:** (autarquia_id, modulo_id)

**Chaves Estrangeiras:**
- `autarquia_id` ‚Üí `autarquias(id)` ON DELETE RESTRICT
- `modulo_id` ‚Üí `modulos(id)` ON DELETE RESTRICT

**√çndices:** autarquia_id, modulo_id, ativo, data_liberacao

---

#### 6. **usuario_modulo_permissao**
Tabela de permiss√µes granulares de usu√°rios nos m√≥dulos por autarquia.

| Campo | Tipo | Descri√ß√£o |
|-------|------|-----------|
| user_id | BIGINT (PK, FK) | Refer√™ncia ao usu√°rio |
| modulo_id | BIGINT (PK, FK) | Refer√™ncia ao m√≥dulo |
| autarquia_id | BIGINT (PK, FK) | Refer√™ncia √† autarquia |
| permissao_leitura | BOOLEAN | Permiss√£o de leitura |
| permissao_escrita | BOOLEAN | Permiss√£o de escrita/edi√ß√£o |
| permissao_exclusao | BOOLEAN | Permiss√£o de exclus√£o |
| permissao_admin | BOOLEAN | Permiss√£o de administrador do m√≥dulo |
| data_concessao | TIMESTAMP | Data de concess√£o da permiss√£o |
| ativo | BOOLEAN | Status da permiss√£o |
| created_at | TIMESTAMP | Data de cria√ß√£o |
| updated_at | TIMESTAMP | Data de atualiza√ß√£o |

**Chave Prim√°ria Composta:** (user_id, modulo_id, autarquia_id)

**Chaves Estrangeiras:**
- `user_id` ‚Üí `users(id)` ON DELETE RESTRICT
- `modulo_id` ‚Üí `modulos(id)` ON DELETE RESTRICT
- `autarquia_id` ‚Üí `autarquias(id)` ON DELETE RESTRICT
- `(autarquia_id, modulo_id)` ‚Üí `autarquia_modulo(autarquia_id, modulo_id)` ON DELETE RESTRICT
  - ‚ö†Ô∏è **Importante:** Garante que s√≥ pode conceder permiss√£o em m√≥dulo liberado para a autarquia

**√çndices:** user_id, modulo_id, autarquia_id, ativo, (user_id, ativo), (autarquia_id, modulo_id)

---

## üîß Migrations Criadas

As seguintes migrations foram criadas na ordem correta de execu√ß√£o:

1. **2025_10_16_150000_create_autarquias_table.php**
2. **2025_10_16_150001_create_modulos_table.php**
3. **2025_10_16_150002_add_autarquia_id_to_users_table.php** *(legado - ser√° substitu√≠do)*
4. **2025_10_16_150003_create_autarquia_modulo_table.php**
5. **2025_10_16_150004_create_usuario_modulo_permissao_table.php**
6. **2025_10_17_000001_create_usuario_autarquia_table.php** üÜï
   - Cria tabela pivot `usuario_autarquia`
   - Adiciona campo `autarquia_ativa_id` em `users`
   - Migra dados existentes de `users.autarquia_id` para a tabela pivot
   - **Remove o campo `autarquia_id` de `users`**

## üå± Seeders

### SuperAdminSeeder

Cria o superadmin do sistema (equipe de suporte SH3).

**Funcionalidade:**
- Cria autarquia "SH3 - Suporte"
- Cria usu√°rio superadmin com acesso total
- Vincula o superadmin √† autarquia SH3 via tabela pivot
- Define a autarquia SH3 como `autarquia_ativa_id`

**Configura√ß√£o via .env:**
```env
SUPERADMIN_NAME="Super Admin"
SUPERADMIN_EMAIL=admin@empresa.com
SUPERADMIN_PASSWORD=admin123
SUPERADMIN_CPF=00000000000
```

### ModulosSeeder

Cria os m√≥dulos do sistema:
- **M√≥dulo 1:** Gest√£o de Frota
- **M√≥dulo 2:** Recursos Humanos
- **M√≥dulo 3:** Almoxarifado
- **M√≥dulo 4:** Contabilidade

### ControlePorAutarquiaSeeder

Popula o banco com dados de teste baseados no seguinte cen√°rio:

#### Autarquias:
- **Autarquia X:** Prefeitura Municipal X
- **Autarquia Y:** Prefeitura Municipal Y
- **Autarquia Z:** Prefeitura Municipal Z

#### Usu√°rios:
| Nome | Email | Autarquias | Role | M√≥dulos com Permiss√£o | N√≠vel |
|------|-------|-----------|------|----------------------|-------|
| Jo√£o Silva | joao.silva@prefeiturax.gov.br | X (default) | gestor | Gest√£o de Frota | Admin |
| Maria Oliveira | maria.oliveira@prefeiturax.gov.br | X (default) | gestor | Recursos Humanos | Admin |
| Pedro Santos | pedro.santos@prefeituray.gov.br | Y (default) | gestor | Gest√£o de Frota, Almoxarifado | Admin |
| Ana Costa | ana.costa@prefeituray.gov.br | Y (default) | user | Contabilidade | Leitura/Escrita |
| Carlos Ferreira | carlos.ferreira@prefeituraz.gov.br | Z (default) | admin | Gest√£o de Frota, Contabilidade | Admin |

**üí° Nota:** Todos os usu√°rios est√£o vinculados a apenas uma autarquia neste exemplo, mas o sistema suporta v√≠nculos m√∫ltiplos.

#### Libera√ß√µes de M√≥dulos:
- **Autarquia X:** Gest√£o de Frota, RH, Almoxarifado
- **Autarquia Y:** Todos os m√≥dulos
- **Autarquia Z:** Gest√£o de Frota, Contabilidade

**Senhas padr√£o:**
- Super Admin: `admin123` (configur√°vel via `.env`)
- Demais usu√°rios: `senha123`

---

## üöÄ Instru√ß√µes de Execu√ß√£o

### 1. Verificar Configura√ß√£o Docker

O arquivo [docker-compose.yaml](../docker-compose.yaml) j√° est√° configurado corretamente com:
- PostgreSQL 17
- Execu√ß√£o autom√°tica de migrations
- Execu√ß√£o autom√°tica de seeders

**N√£o √© necess√°rio modificar a configura√ß√£o Docker atual.**

### 2. Executar Migrations e Seeders

#### Op√ß√£o A: Via Docker (Recomendado)
```bash
# Parar os containers
docker compose down

# Limpar os volumes (ATEN√á√ÉO: Apaga todos os dados)
docker compose down -v

# Subir os containers (migrations e seeders executam automaticamente)
docker compose up -d
```

#### Op√ß√£o B: Manualmente (se necess√°rio)
```bash
# Acessar o container
docker exec -it gestao_frota_app_local bash

# Executar migrations
php artisan migrate

# Executar seeders
php artisan db:seed

# Ou executar migration e seed juntos (limpa tudo)
php artisan migrate:fresh --seed
```

### 3. Verificar Dados no Banco

```bash
# Acessar o PostgreSQL
docker exec -it gestao_frota_db_local psql -U root -d frota

# Consultas √∫teis
SELECT * FROM autarquias;
SELECT * FROM modulos;
SELECT * FROM users;
SELECT * FROM usuario_autarquia;  -- NOVA TABELA
SELECT * FROM autarquia_modulo;
SELECT * FROM usuario_modulo_permissao;

# Verificar v√≠nculos de um usu√°rio com autarquias
SELECT
    u.name,
    a.nome as autarquia,
    ua.role,
    ua.is_admin,
    ua.is_default,
    ua.ativo
FROM usuario_autarquia ua
JOIN users u ON ua.user_id = u.id
JOIN autarquias a ON ua.autarquia_id = a.id
WHERE u.email = 'joao.silva@prefeiturax.gov.br';

# Verificar permiss√µes de um usu√°rio
SELECT
    u.name,
    m.nome as modulo,
    a.nome as autarquia,
    ump.permissao_leitura,
    ump.permissao_escrita,
    ump.permissao_exclusao,
    ump.permissao_admin
FROM usuario_modulo_permissao ump
JOIN users u ON ump.user_id = u.id
JOIN modulos m ON ump.modulo_id = m.id
JOIN autarquias a ON ump.autarquia_id = a.id
WHERE u.email = 'joao.silva@prefeiturax.gov.br';
```

---

## üìä Diagrama ER Atualizado

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   autarquias    ‚îÇ         ‚îÇ     modulos      ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§         ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ id (PK)         ‚îÇ         ‚îÇ id (PK)          ‚îÇ
‚îÇ nome (UNIQUE)   ‚îÇ         ‚îÇ nome (UNIQUE)    ‚îÇ
‚îÇ ativo           ‚îÇ         ‚îÇ descricao        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îÇ icone            ‚îÇ
         ‚îÇ                  ‚îÇ ativo            ‚îÇ
         ‚îÇ                  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ                           ‚îÇ
         ‚îÇ    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ    ‚îÇ                                              ‚îÇ
         ‚îÇ    ‚îÇ     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§   autarquia_modulo (pivot)     ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
              ‚îÇ     ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
              ‚îÇ     ‚îÇ autarquia_id (PK, FK)          ‚îÇ
              ‚îÇ     ‚îÇ modulo_id (PK, FK)             ‚îÇ
              ‚îÇ     ‚îÇ data_liberacao                 ‚îÇ
              ‚îÇ     ‚îÇ ativo                          ‚îÇ
              ‚îÇ     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
              ‚îÇ                   ‚îÇ
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê          ‚îÇ
         ‚îÇ    users    ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§          ‚îÇ                ‚îÇ
         ‚îÇ id (PK)     ‚îÇ          ‚îÇ                ‚îÇ
         ‚îÇ name        ‚îÇ          ‚îÇ                ‚îÇ
         ‚îÇ email       ‚îÇ          ‚îÇ                ‚îÇ
         ‚îÇ cpf         ‚îÇ          ‚îÇ                ‚îÇ
         ‚îÇ password    ‚îÇ          ‚îÇ                ‚îÇ
         ‚îÇ autarquia_  ‚îÇ          ‚îÇ                ‚îÇ
         ‚îÇ   ativa_id  ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                ‚îÇ
         ‚îÇ role        ‚îÇ                           ‚îÇ
         ‚îÇ is_active   ‚îÇ                           ‚îÇ
         ‚îÇis_superadmin‚îÇ                           ‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                           ‚îÇ
                ‚îÇ                                  ‚îÇ
                ‚îÇ  üÜï N:N via usuario_autarquia    ‚îÇ
                ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                ‚îî‚îÄ‚îÄ‚î§ usuario_autarquia (pivot) üÜï ‚îÇ
                   ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
                   ‚îÇ id (PK)                       ‚îÇ
                   ‚îÇ user_id (FK)                  ‚îÇ
                   ‚îÇ autarquia_id (FK)             ‚îÇ
                   ‚îÇ role                          ‚îÇ
                   ‚îÇ is_admin                      ‚îÇ
                   ‚îÇ is_default                    ‚îÇ
                   ‚îÇ ativo                         ‚îÇ
                   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                   ‚îÇ
                   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                   ‚îÇ   usuario_modulo_permissao (pivot)           ‚îÇ
                   ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
                   ‚îÇ user_id (PK, FK)                             ‚îÇ
                   ‚îÇ modulo_id (PK, FK)                           ‚îÇ
                   ‚îÇ autarquia_id (PK, FK)                        ‚îÇ
                   ‚îÇ permissao_leitura                            ‚îÇ
                   ‚îÇ permissao_escrita                            ‚îÇ
                   ‚îÇ permissao_exclusao                           ‚îÇ
                   ‚îÇ permissao_admin                              ‚îÇ
                   ‚îÇ data_concessao                               ‚îÇ
                   ‚îÇ ativo                                        ‚îÇ
                   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üîê Integridade Referencial

Todas as chaves estrangeiras utilizam **ON DELETE RESTRICT** ou **CASCADE** conforme apropriado:
- `usuario_autarquia`: CASCADE (se usu√°rio ou autarquia for exclu√≠do, remove v√≠nculos)
- `autarquia_modulo`: RESTRICT (n√£o permite excluir autarquia/m√≥dulo com v√≠nculos ativos)
- `usuario_modulo_permissao`: RESTRICT (n√£o permite excluir registros com permiss√µes ativas)

---

## üìù Observa√ß√µes Importantes

### 1. Relacionamento N:N entre Usu√°rios e Autarquias

**‚ú® Nova Funcionalidade:**
- Um usu√°rio pode estar vinculado a **m√∫ltiplas autarquias**
- Cada v√≠nculo pode ter role e is_admin espec√≠ficos
- Campo `autarquia_ativa_id` em `users` indica qual autarquia est√° ativa no momento
- Campo `is_default` em `usuario_autarquia` indica a autarquia padr√£o

**Casos de Uso:**
- Usu√°rio que trabalha em m√∫ltiplas prefeituras
- Consultor que presta servi√ßo para v√°rios clientes
- Administrador que gerencia m√∫ltiplas autarquias

**Como Trocar de Autarquia:**
- Frontend: Use o endpoint `/user/switch-autarquia`
- Backend: M√©todo `User::trocarAutarquia($autarquiaId)`
- Atualiza `autarquia_ativa_id` automaticamente

### 2. Sistema de Permiss√µes Granular
O sistema implementa 4 n√≠veis de permiss√£o:
- **Leitura:** Visualizar dados do m√≥dulo
- **Escrita:** Criar e editar dados
- **Exclus√£o:** Remover dados
- **Admin:** Administrador do m√≥dulo (pode gerenciar outros usu√°rios)

### 3. Valida√ß√£o de Integridade
A tabela `usuario_modulo_permissao` possui uma constraint que garante que um usu√°rio s√≥ pode ter permiss√£o em um m√≥dulo que est√° liberado para sua autarquia atrav√©s da foreign key composta `(autarquia_id, modulo_id)`.

### 4. √çndices de Performance
Todos os campos frequentemente utilizados em queries possuem √≠ndices:
- Chaves estrangeiras
- Campos de status (ativo)
- Campos de busca (nome)
- Combina√ß√µes √∫teis (user_id + ativo, autarquia_id + modulo_id, user_id + autarquia_id)

### 5. Modo Suporte (Superadmin)

**Usu√°rios Superadmin (SH3):**
- T√™m acesso a **todas as autarquias** sem necessidade de v√≠nculo expl√≠cito
- Podem assumir contexto de qualquer autarquia via endpoint `/support/assume-context`
- Flag `is_superadmin = true` concede privil√©gios especiais
- Vinculados √† autarquia "SH3 - Suporte" por padr√£o

**Endpoints de Suporte:**
- `POST /support/assume-context` - Assume contexto de uma autarquia
- `POST /support/exit-context` - Retorna ao contexto original
- `GET /user/autarquias` - Lista autarquias dispon√≠veis

---

## üîÑ Mudan√ßas em Rela√ß√£o √† Vers√£o Anterior

### ‚ùå Removido:
- Campo `autarquia_id` da tabela `users`
- Relacionamento 1:N entre User e Autarquia

### ‚úÖ Adicionado:
- Tabela `usuario_autarquia` (pivot N:N)
- Campo `autarquia_ativa_id` em `users` (contexto atual)
- Campo `is_default` em `usuario_autarquia` (autarquia padr√£o)
- Suporte a m√∫ltiplas autarquias por usu√°rio

### üîß Modificado:
- Models `User` e `Autarquia` agora usam `belongsToMany`
- Controllers adaptados para nova estrutura
- Seeders atualizados para usar tabela pivot

---

## ‚úÖ Valida√ß√£o

Para validar que tudo foi criado corretamente:

```bash
# Verificar se as tabelas foram criadas
docker exec -it gestao_frota_db_local psql -U root -d frota -c "\dt"

# Verificar quantidade de registros
docker exec -it gestao_frota_db_local psql -U root -d frota -c "
SELECT
    'autarquias' as tabela, COUNT(*) as registros FROM autarquias
UNION ALL
SELECT 'modulos', COUNT(*) FROM modulos
UNION ALL
SELECT 'users', COUNT(*) FROM users
UNION ALL
SELECT 'usuario_autarquia', COUNT(*) FROM usuario_autarquia
UNION ALL
SELECT 'autarquia_modulo', COUNT(*) FROM autarquia_modulo
UNION ALL
SELECT 'usuario_modulo_permissao', COUNT(*) FROM usuario_modulo_permissao;
"
```

**Resultado esperado:**
- autarquias: 4 registros (1 SH3 - Suporte + 3 clientes)
- modulos: 4 registros
- users: 6 registros (1 superadmin + 5 usu√°rios de teste)
- usuario_autarquia: 6 registros (1 v√≠nculo por usu√°rio) üÜï
- autarquia_modulo: 9 registros
- usuario_modulo_permissao: 7 registros

---

## üîê Autarquia SH3 - Suporte

A autarquia **SH3 - Suporte** √© uma autarquia especial criada automaticamente pelo sistema para abrigar usu√°rios da equipe de suporte.

### Caracter√≠sticas:
- ‚úÖ Criada automaticamente ao executar o `SuperAdminSeeder`
- ‚úÖ Usu√°rios com `is_superadmin = true` t√™m acesso total
- ‚úÖ Superadmins podem assumir contexto de qualquer autarquia
- ‚úÖ N√£o requer v√≠nculo expl√≠cito na tabela `usuario_autarquia` para acessar outras autarquias
- ‚úÖ Permite que a equipe de suporte fa√ßa implanta√ß√£o e interven√ß√µes nos sistemas dos clientes

### Uso:
- Para criar novos usu√°rios de suporte, crie-os com `is_superadmin: true`
- Vincule-os √† autarquia SH3 via tabela pivot
- Superadmins n√£o precisam de permiss√µes espec√≠ficas nos m√≥dulos - eles t√™m acesso total automaticamente

---

üìå **Documenta√ß√£o atualizada em:** 17/10/2025
üìå **√öltima revis√£o:** Implementa√ß√£o do relacionamento N:N entre usu√°rios e autarquias
